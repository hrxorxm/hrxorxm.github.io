---
layout: post
title:  "[Boostcamp AI Tech] 21ì¼ì°¨ í•™ìŠµì •ë¦¬"
subtitle:   "Naver Boostcamp AI Tech Level1 Day21"
categories: "Boostcamp-AI-Tech"
tags: [5ì£¼ì°¨, Level1-P-Stage]
use_math: true
---

# ë¶€ìŠ¤íŠ¸ìº í”„ 21ì¼ì°¨

## ğŸ“ ì˜¤ëŠ˜ ì¼ì • ì •ë¦¬

* 8/31 (í™”)
  - [x] ëŒ€íšŒ ì§„í–‰ ë‚´ìš©
    - [x] train/valid split by profile and stratified labels
    - [x] confusion matrix ê·¸ë ¤ë³´ê¸°
    - [x] pre-trained modelì˜ dropout ë¹„ìœ¨ ë°”ê¿”ë³´ê¸°

## ğŸŒ± í”¼ì–´ ì„¸ì…˜ ì •ë¦¬

- í•œ ëª¨ë¸ë¡œ í•™ìŠµ/ì„¸ ëª¨ë¸ë¡œ ë‚˜ëˆ ì„œ í•™ìŠµí•˜ëŠ” ëª¨ë“ˆ ì¶”ê°€
- pretrained ëª¨ë¸ì— dropout=0.7 (drop_rate in timm)
- train/valid split : ì‚¬ëŒë³„ë¡œ ë‚˜ëˆ„ë˜, ë¼ë²¨ë³„ë¡œ ê· ë“±í•˜ê²Œ
- Densenetì´ ë‹¤ë¥¸ ëª¨ë¸ë³´ë‹¤ 2% ì •ë„ ë†’ê²Œ ë‚˜ì™”ë‹¤.
- augmentation : ê°€ìš°ì‹œì•ˆ, Cutmix, sharpness, contrast ë“±ì„ ì´ìš©í•´ë³´ì

## ğŸš© ëŒ€íšŒ ì§„í–‰ ë‚´ìš©

### train/valid split by profile and stratified labels

* ì½”ë“œ
  ```python
  from pandas_streaming.df import train_test_apart_stratify
  def split_dataset(self) -> Tuple[Subset, Subset]:
      df = pd.DataFrame({"indexs":self.indexs, "groups":self.groups, "labels":self.all_labels})
      train, valid = train_test_apart_stratify(df, group="groups", stratify="labels", test_size=self.val_ratio)
      train_index = train["indexs"].tolist()
      valid_index = valid["indexs"].tolist()
      return  [Subset(self, train_index), Subset(self, valid_index)]
  ```

### confusion matrix ê·¸ë ¤ë³´ê¸°

* ì½”ë“œ
  ```python
  model.eval()
  targets_list = list()
  preds_list = list()
  for i, (images, targets) in enumerate(train_loader) : 
      images = images.to(device)
      targets = targets.to(device)
  
      with torch.no_grad():
          scores = model(images)
          _, preds = scores.max(dim=1)
  
      targets_list.extend(targets.cpu())
      preds_list.extend(preds.cpu())
  
  cm = confusion_matrix(targets_list, preds_list)
  disp = ConfusionMatrixDisplay(confusion_matrix=cm, display_labels=range(18))
  fig, ax = plt.subplots(figsize=(10, 10))
  disp.plot(ax=ax, cmap=plt.cm.Blues)
  ```

* ê·¸ë˜í”„

  |                       Confusion Matrix                       |                  Confusion Matrix (no diag)                  |
  | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![image](https://user-images.githubusercontent.com/35680202/131479099-8d0e3f93-6a2b-4079-ba0d-cd5852b62937.png) | ![image](https://user-images.githubusercontent.com/35680202/131480362-6098385d-39d9-4b97-96ba-aef3784fae5d.png) |

* ë¶„ì„
  * ë‚˜ì´
    * ë§ˆìŠ¤í¬ë¥¼ ì“°ë©´ ë‚˜ì´ì¸ì‹ì´ ì–´ë ¤ì›Œì§„ë‹¤.
      * 0-1, 1-0, 1-2, 2-1 : wear - male - [0~30 or 30~60 or 60~]
      * 3-4, 4-5 : wear - female - [0~30 or 30~60 or 60~]
    * ë§ˆìŠ¤í¬ë¥¼ ì œëŒ€ë¡œ ì•ˆ ì¨ë„ ë‚˜ì´ ì¸ì‹ì´ ì–´ë ¤ì›Œì§„ë‹¤.
      * 7-8, 8-7 : incorrect - male - [30~60 or 60~]
      * 10-9, 11-10 : incorrect - female - [0~30 or 30~60 or 60~]
  * ì„±ë³„
    * ë§ˆìŠ¤í¬ë¥¼ ì“°ë©´ ì„±ë³„ ì¸ì‹ë„ ì–´ë ¤ì›Œì§„ë‹¤.
      * 0-3, 3-0, 1-4, 4-1 (ë‚¨/ì—¬ ëª¨ë‘ í˜¼ë™) : wear - [male or female] - 0~60
      * 9-6, 10-7 (ì—¬ë¥¼ ë‚¨ìœ¼ë¡œ ì¸ì‹) : incorrect - [male or female] - 0~60
    * ë§ˆìŠ¤í¬ë¥¼ ì•ˆ ì“°ë©´ ì—¬ìë¥¼ ë‚¨ìë¡œ ì¸ì‹í•œë‹¤.
      * 15-12, 16-13, 17-14 : not wear - [male or female] - 0~100

### pre-trained modelì˜ dropout ë¹„ìœ¨ ë°”ê¿”ë³´ê¸°

* ì½”ë“œ
  ```python
  class EfficientNet_b3_dropout(nn.Module):
      def __init__(self, num_classes):
          super().__init__()
          self.model = timm.create_model('efficientnet_b3', pretrained=True, num_classes=num_classes, drop_rate=0.7)
  
      def forward(self, x):
          return self.model(x)
  ```

* ê²°ê³¼

  |                           ì ìš© ì „                            |                           ì ìš© í›„                            |
  | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![image](https://user-images.githubusercontent.com/35680202/131479099-8d0e3f93-6a2b-4079-ba0d-cd5852b62937.png) | ![image](https://user-images.githubusercontent.com/35680202/131493768-5fdeb363-e69c-4e1f-b3a3-afe28af2af6f.png) |
  | ![image](https://user-images.githubusercontent.com/35680202/131480362-6098385d-39d9-4b97-96ba-aef3784fae5d.png) | ![image](https://user-images.githubusercontent.com/35680202/131493854-94a6811d-65f9-4f77-ba72-c90d5599ede0.png) |
  |   [val] best acc: 88.21%, best loss: 0.4, best f1: 0.8139    |   [val] best acc: 89.11%, best loss: 0.33, best f1: 0.8137   |

  * ìˆ˜ì¹˜ì ìœ¼ë¡œëŠ” ì„±ëŠ¥ì´ ë¹„ìŠ·í•˜ì§€ë§Œ, ì¼ë¶€ í´ë˜ìŠ¤ ì˜ˆì¸¡ ì˜¤ì°¨ê°€ ëŠ˜ì—ˆë‹¤.


## ğŸš€ í•™ìŠµ íšŒê³ 

* ì–´ì œëŠ” íŒ€ ì½”ë“œì— í•©ì¹˜ëŠ” ì‘ì—…ì´ í•„ìš”ì—†ì–´ ë³´ì˜€ëŠ”ë°, ê°ìì˜ ê¸°ëŠ¥ì„ í•©ì³ì„œ ì‚¬ìš©í•˜ë ¤ê³  í•  ë•Œ ë„ì›€ì´ ë˜ì–´ì„œ í•˜ê¸¸ ì˜ í–ˆë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤.
* ì„±ëŠ¥ì„ ë†’ì´ëŠ”ê²Œ ì‰½ì§€ ì•Šì§€ë§Œ, ë‚˜ë¦„ëŒ€ë¡œ ê²°ê³¼ë¥¼ ë¶„ì„í•´ë³´ëŠ” ê²ƒë„ ì¬ë°ŒëŠ” ê²ƒ ê°™ë‹¤.

